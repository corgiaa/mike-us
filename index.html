<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我们的宇宙空间</title>
    <script src="//cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <style>
        /* --- 全局样式 --- */
        body { margin: 0; padding: 0; background: #000; font-family: 'Microsoft YaHei', sans-serif; color: #fff; overflow: hidden; width: 100vw; height: 100vh; user-select: none; }

        /* --- 开场动画 --- */
        #intro-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; transition: opacity 1s ease; }
        
        /* 星球容器 - 移除CSS动画，改用JS控制 */
        #planet-container { 
            width: 100%; height: 100%; 
            cursor: grab; 
            position: absolute;
            top: 0; left: 0;
        }
        #planet-container:active { cursor: grabbing; }

        /* 点击提示文字 */
        #click-hint { 
            position: absolute;
            bottom: 15%;
            color: #87cefa; 
            font-size: 1.1rem; 
            letter-spacing: 6px;
            animation: pulse 2s infinite; 
            font-weight: 300;
            text-transform: uppercase;
            text-shadow: 0 0 10px rgba(135, 206, 250, 0.6);
            pointer-events: none; /* 让点击穿透到地球 */
            z-index: 2001;
        }
        @keyframes pulse { 0% { opacity: 0.3; } 50% { opacity: 1; } 100% { opacity: 0.3; } }

        /* --- 主界面 --- */
        #main-app { opacity: 0; pointer-events: none; transition: opacity 1.5s ease; width: 100%; height: 100%; display: flex; position: relative; }
        #main-app.active { opacity: 1; pointer-events: all; }

        /* 左侧面板 */
        #left-panel { width: 320px; height: 100%; background: rgba(20, 20, 30, 0.6); backdrop-filter: blur(15px); border-right: 1px solid rgba(255, 255, 255, 0.1); padding: 40px 30px; box-sizing: border-box; display: flex; flex-direction: column; z-index: 100; position: relative; }
        .app-title { font-size: 1.8rem; color: #87cefa; margin-bottom: 10px; font-weight: bold; }
        .app-desc { font-size: 0.9rem; color: #aaa; line-height: 1.6; margin-bottom: 40px; }
        .timer-box { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); cursor: pointer; transition: 0.3s; position: relative; }
        .timer-box:hover { background: rgba(255,255,255,0.1); border-color: #87cefa; }
        .timer-box:hover::after { content: "点击修改时间"; position: absolute; top: -25px; right: 0; font-size: 12px; color: #87cefa; }
        .timer-label { font-size: 0.8rem; color: #888; margin-bottom: 5px; }
        #timer-display { font-size: 1.2rem; color: #fff; font-family: monospace; }

        /* 右侧内容区 */
        #right-panel { flex: 1; position: relative; overflow: hidden; }
        #meteor-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }

        /* 视图层 */
        .view-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transition: opacity 0.5s, transform 0.5s; }
        .view-layer.hidden { opacity: 0; pointer-events: none; transform: scale(0.95); }

        /* 照片卡片 */
        .memory-card { position: absolute; width: 260px; background: rgba(30, 30, 40, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 12px; padding: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); cursor: grab; transition: 0.3s; color: #eee; }
        .memory-card:hover { box-shadow: 0 15px 40px rgba(135, 206, 250, 0.2); border-color: rgba(135, 206, 250, 0.5); z-index: 999 !important; }
        .memory-card.playing { border-color: #87cefa; box-shadow: 0 0 25px rgba(135, 206, 250, 0.6); transform: scale(1.02); z-index: 990; }
        .memory-card.playing .music-badge i { animation: spin 2s linear infinite; color: #87cefa; }
        .memory-card img { width: 100%; border-radius: 8px; pointer-events: none; display: block; margin-bottom: 10px; }
        .memory-text { font-size: 0.9rem; line-height: 1.5; margin-bottom: 8px; color: #ddd; }
        .memory-date { font-size: 0.75rem; color: #888; display: flex; justify-content: space-between; align-items: center; }
        .music-badge { color: #666; font-size: 14px; transition: 0.3s; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* 便签卡片 */
        #note-layer { overflow-y: auto; padding: 40px; display: flex; flex-wrap: wrap; gap: 20px; align-content: flex-start; box-sizing: border-box; }
        .note-card { width: 200px; min-height: 180px; background: #fdfd96; color: #333; padding: 20px; border-radius: 5px; box-shadow: 5px 5px 15px rgba(0,0,0,0.3); font-family: 'Comic Sans MS', 'YouYuan', sans-serif; position: relative; transition: transform 0.2s; cursor: default; display: flex; flex-direction: column; justify-content: space-between; animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .note-card:hover { transform: scale(1.05) rotate(0deg) !important; z-index: 100; box-shadow: 10px 10px 25px rgba(0,0,0,0.4); }
        .note-content { font-size: 1rem; line-height: 1.6; white-space: pre-wrap; font-weight: bold; }
        .note-footer { margin-top: 15px; font-size: 0.75rem; color: rgba(0,0,0,0.5); text-align: right; display: flex; justify-content: space-between; align-items: center; }
        .note-pin { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 15px; height: 15px; border-radius: 50%; background: rgba(0,0,0,0.2); box-shadow: inset 0 2px 5px rgba(0,0,0,0.5); }
        .note-yellow { background: #fdfd96; transform: rotate(-2deg); }
        .note-blue { background: #84fab0; transform: rotate(3deg); }
        .note-pink { background: #ff9a9e; transform: rotate(-1deg); }
        .note-purple { background: #a18cd1; color: #fff; transform: rotate(2deg); }
        .btn-delete { position: absolute; top: 5px; right: 5px; color: rgba(0,0,0,0.2); cursor: pointer; font-size: 14px; z-index: 10; }
        .btn-delete:hover { color: #ff4d4d; }
        .memory-card .btn-delete { color: rgba(255,255,255,0.2); }
        @keyframes popIn { from { opacity: 0; transform: scale(0.5); } to { opacity: 1; transform: scale(1); } }

        /* 底部控制栏 */
        #control-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: center; align-items: center; gap: 40px; z-index: 1000; }
        .ctrl-btn { color: #aaa; cursor: pointer; display: flex; flex-direction: column; align-items: center; font-size: 0.8rem; transition: 0.3s; position: relative; }
        .ctrl-btn i { font-size: 1.2rem; margin-bottom: 4px; }
        .ctrl-btn:hover, .ctrl-btn.active { color: #87cefa; }
        .ctrl-btn.active::after { content: ''; position: absolute; bottom: -5px; width: 20px; height: 3px; background: #87cefa; border-radius: 2px; }

        /* 弹窗 */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-box { background: #1a1a1a; width: 90%; max-width: 400px; padding: 25px; border-radius: 15px; border: 1px solid #333; color: #fff; position: relative; }
        .modal-close { position: absolute; top: 15px; right: 15px; cursor: pointer; font-size: 20px; color: #666; }
        .input-group { margin-bottom: 15px; }
        .input-group input, .input-group textarea { width: 100%; background: #333; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 5px; box-sizing: border-box; outline: none; }
        #preview-box img { max-width: 100%; max-height: 150px; border-radius: 5px; display: block; margin: 10px auto; }
        .btn-submit { width: 100%; background: #87cefa; color: #000; border: none; padding: 12px; border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .type-switch { display: flex; gap: 10px; margin-bottom: 15px; }
        .type-btn { flex: 1; padding: 8px; background: #333; border: 1px solid #444; color: #888; border-radius: 5px; cursor: pointer; text-align: center; font-size: 0.9rem; }
        .type-btn.active { background: #87cefa; color: #000; border-color: #87cefa; font-weight: bold; }
        .color-options { display: flex; gap: 10px; margin-bottom: 15px; justify-content: center; display: none; }
        .color-dot { width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .color-dot.selected { border-color: #fff; transform: scale(1.1); }
    </style>
</head>
<body>

    <audio id="bgm-player"></audio>

    <div id="intro-screen">
        <div id="planet-container"></div>
        <div id="click-hint">按住拖拽星球 / 双击进入</div>
    </div>

    <div id="main-app">
        <div id="left-panel">
            <div class="app-title">COSMIC LOVE</div>
            <div class="app-desc">
                左侧是宇宙的回响，<br>右侧是生活的点滴。<br>(提示: 点击下方按钮切换视图)
            </div>
            <div class="timer-box" onclick="editDate()">
                <div class="timer-label">我们已经航行了 (点此修改)</div>
                <div id="timer-display">...</div>
            </div>
        </div>
        <div id="right-panel">
            <canvas id="meteor-canvas"></canvas>
            <div id="memory-layer" class="view-layer"></div>
            <div id="note-layer" class="view-layer hidden"></div>
        </div>
        <div id="control-bar">
            <div class="ctrl-btn active" id="nav-photo" onclick="switchView('photo')"><i class="fas fa-star"></i> 宇宙</div>
            <div class="ctrl-btn" onclick="openModal()"><i class="fas fa-plus-circle" style="font-size: 2rem; color: #87cefa;"></i></div>
            <div class="ctrl-btn" id="nav-note" onclick="switchView('note')"><i class="fas fa-sticky-note"></i> 便签</div>
        </div>
    </div>

    <div class="modal-overlay" id="add-modal">
        <div class="modal-box">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <h3 style="text-align:center;">记录</h3>
            <div class="type-switch">
                <div class="type-btn active" onclick="toggleType('photo')" id="btn-type-photo">照片/音乐</div>
                <div class="type-btn" onclick="toggleType('note')" id="btn-type-note">便签/待办</div>
            </div>
            <div id="photo-fields">
                <div class="input-group" style="border: 2px dashed #444; padding: 20px; text-align: center; cursor: pointer;" onclick="document.getElementById('file-input').click()">
                    <p style="margin:0; color:#888;">点击选择照片</p>
                    <input type="file" id="file-input" accept="image/*" style="display:none" onchange="handleFileSelect(this)">
                </div>
                <div id="preview-box"></div>
                <div class="input-group"><input type="text" id="input-music" placeholder="音乐链接 (可选)"></div>
            </div>
            <div id="note-fields" style="display:none;">
                <div class="color-options" style="display:flex;">
                    <div class="color-dot note-yellow selected" onclick="selectColor('note-yellow')"></div>
                    <div class="color-dot note-blue" style="background:#84fab0" onclick="selectColor('note-blue')"></div>
                    <div class="color-dot note-pink" style="background:#ff9a9e" onclick="selectColor('note-pink')"></div>
                    <div class="color-dot note-purple" style="background:#a18cd1" onclick="selectColor('note-purple')"></div>
                </div>
            </div>
            <div class="input-group"><textarea id="input-content" rows="4" placeholder="写下内容..."></textarea></div>
            <button class="btn-submit" id="btn-pub" onclick="publish()">发布</button>
        </div>
    </div>

    <script>
        const CONFIG = {
            appId: 'gxw6RPvsW0eKgz0uvv7r78LF-MdYXbMMI',
            appKey: 'FAhjdMJ1gGA5WggHPqO5cBF8',
            serverURL: 'https://gxw6rpvs.api.lncldglobal.com',
            defaultDate: '2023-05-20T13:14:00',
            defaultMusic: 'https://files.freemusicarchive.org/storage-new/music/ccCommunity/Kai_Engel/Satin/Kai_Engel_-_04_-_Sentinel.mp3'
        };

        AV.init({ appId: CONFIG.appId, appKey: CONFIG.appKey, serverURL: CONFIG.serverURL });

        // --- 1. 视图切换 ---
        let currentView = 'photo';
        function switchView(view) {
            currentView = view;
            const photoLayer = document.getElementById('memory-layer');
            const noteLayer = document.getElementById('note-layer');
            const navPhoto = document.getElementById('nav-photo');
            const navNote = document.getElementById('nav-note');
            const meteorCanvas = document.getElementById('meteor-canvas');

            if (view === 'photo') {
                photoLayer.classList.remove('hidden'); noteLayer.classList.add('hidden');
                navPhoto.classList.add('active'); navNote.classList.remove('active');
                meteorCanvas.style.opacity = 1;
            } else {
                photoLayer.classList.add('hidden'); noteLayer.classList.remove('hidden');
                navPhoto.classList.remove('active'); navNote.classList.add('active');
                meteorCanvas.style.opacity = 0.2;
            }
            if(view === 'note') loadMemories();
        }

        // --- 2. 计时器 ---
        let startDateStr = localStorage.getItem('loveStartDate') || CONFIG.defaultDate;
        function updateTimerDisplay() {
            const diff = new Date() - new Date(startDateStr);
            const d=Math.floor(diff/86400000), h=Math.floor((diff/3600000)%24), m=Math.floor((diff/60000)%60), s=Math.floor((diff/1000)%60);
            document.getElementById('timer-display').innerText = `${d}天 ${h}时 ${m}分 ${s}秒`;
        }
        setInterval(updateTimerDisplay, 1000);
        function editDate() {
            const newDate = prompt("请输入新的开始时间 (格式: YYYY-MM-DD HH:mm:ss)", startDateStr.replace('T', ' '));
            if (newDate) {
                if(new Date(newDate).toString() === 'Invalid Date') { alert("日期格式不对"); return; }
                startDateStr = newDate; localStorage.setItem('loveStartDate', startDateStr);
                alert("时间已更新！"); updateTimerDisplay();
            }
        }

        // --- 3. 数据加载 ---
        const memoryLayer = document.getElementById('memory-layer');
        const noteLayer = document.getElementById('note-layer');
        let zIndexCounter = 10;

        async function loadMemories() {
            const query = new AV.Query('Memory'); query.descending('createdAt'); query.limit(100);
            try {
                const list = await query.find();
                memoryLayer.innerHTML = ''; noteLayer.innerHTML = '';
                list.forEach(item => {
                    const data = item.attributes;
                    if (data.imgUrl === 'NOTE_TYPE') createNote(item);
                    else createPhotoCard(item);
                });
                if(currentView === 'photo') scatterCards();
            } catch (err) { console.error(err); }
        }

        function createPhotoCard(item) {
            const data = item.attributes;
            const div = document.createElement('div');
            div.className = 'memory-card'; div.id = 'card-' + item.id;
            const musicUrl = (data.musicUrl && data.musicUrl.startsWith('http')) ? data.musicUrl : CONFIG.defaultMusic;
            let startX, startY;
            div.addEventListener('mousedown', (e) => { div.style.zIndex = ++zIndexCounter; startX = e.clientX; startY = e.clientY; });
            div.addEventListener('mouseup', (e) => {
                if (Math.abs(e.clientX - startX) < 5 && Math.abs(e.clientY - startY) < 5 && !e.target.closest('.btn-delete')) {
                    toggleMusic(musicUrl, div);
                }
            });
            const imgHtml = data.imgUrl ? `<img src="${data.imgUrl}" draggable="false">` : '';
            div.innerHTML = `<div class="btn-delete" onclick="deleteMemory('${item.id}', event)"><i class="fas fa-times"></i></div>${imgHtml}<div class="memory-text">${data.content || ''}</div><div class="memory-date"><span>${item.createdAt.toLocaleDateString()}</span><div class="music-badge"><i class="fas fa-music"></i></div></div>`;
            setupDrag(div); memoryLayer.appendChild(div);
        }

        function createNote(item) {
            const data = item.attributes;
            const div = document.createElement('div');
            const colorClass = data.musicUrl || 'note-yellow'; 
            div.className = `note-card ${colorClass}`; div.id = 'card-' + item.id;
            div.style.transform = `rotate(${(Math.random() - 0.5) * 6}deg)`;
            div.innerHTML = `<div class="note-pin"></div><div class="btn-delete" onclick="deleteMemory('${item.id}', event)"><i class="fas fa-times"></i></div><div class="note-content">${data.content || ''}</div><div class="note-footer">${item.createdAt.toLocaleDateString()} <i class="fas fa-pen-fancy"></i></div>`;
            noteLayer.appendChild(div);
        }

        // --- 4. 发布 ---
        let currentType = 'photo'; let selectedNoteColor = 'note-yellow'; let selectedFile = null;
        function openModal() { document.getElementById('add-modal').style.display = 'flex'; }
        function closeModal() { document.getElementById('add-modal').style.display = 'none'; }
        function toggleType(type) {
            currentType = type;
            document.getElementById('btn-type-photo').className = type === 'photo' ? 'type-btn active' : 'type-btn';
            document.getElementById('btn-type-note').className = type === 'note' ? 'type-btn active' : 'type-btn';
            document.getElementById('photo-fields').style.display = type === 'photo' ? 'block' : 'none';
            document.getElementById('note-fields').style.display = type === 'note' ? 'block' : 'none';
            if(type === 'note') document.querySelector('.color-options').style.display = 'flex';
        }
        function selectColor(color) {
            selectedNoteColor = color;
            document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('selected'));
            document.querySelector('.' + color).classList.add('selected');
        }
        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                selectedFile = input.files[0];
                const r = new FileReader(); r.onload = (e) => document.getElementById('preview-box').innerHTML = `<img src="${e.target.result}">`; r.readAsDataURL(selectedFile);
            }
        }
        async function publish() {
            const text = document.getElementById('input-content').value;
            const btn = document.getElementById('btn-pub');
            if (!text && !selectedFile && currentType === 'photo') return alert("照片模式需要图片或文字");
            if (!text && currentType === 'note') return alert("便签不能为空");
            btn.disabled = true; btn.innerText = "上传中...";
            try {
                const M = AV.Object.extend('Memory'); const m = new M();
                if (currentType === 'photo') {
                    let imgUrl = "";
                    if (selectedFile) { const f = new AV.File(selectedFile.name, selectedFile); await f.save(); imgUrl = f.url(); }
                    m.set('content', text); m.set('imgUrl', imgUrl); m.set('musicUrl', document.getElementById('input-music').value);
                } else {
                    m.set('content', text); m.set('imgUrl', 'NOTE_TYPE'); m.set('musicUrl', selectedNoteColor);
                }
                await m.save();
                closeModal();
                document.getElementById('input-content').value = ''; document.getElementById('preview-box').innerHTML = ''; selectedFile = null;
                if(currentType !== currentView) switchView(currentType); else loadMemories();
                alert("发布成功！");
            } catch (e) { alert("发布失败: " + e.message); }
            btn.disabled = false; btn.innerText = "发布";
        }

        // --- 5. 3D星球 (超真实版 + 拖拽交互) ---
        const pl = document.getElementById('planet-container');
        let scene, camera, renderer, group;
        let isDragging = false, previousMousePosition = { x: 0, y: 0 };

        window.onload = () => { initPlanet(); };

        function initPlanet() {
            const w = window.innerWidth; // 全屏渲染
            const h = window.innerHeight;
            scene = new THREE.Scene();
            
            // 相机位置
            camera = new THREE.PerspectiveCamera(45, w / h, 0.1, 1000);
            camera.position.z = 18;

            renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(w, h);
            pl.appendChild(renderer.domElement);

            group = new THREE.Group();
            scene.add(group);

            const loader = new THREE.TextureLoader();

            // 地球本体 (4K贴图)
            const earthGeo = new THREE.SphereGeometry(5, 64, 64);
            const earthMat = new THREE.MeshPhongMaterial({
                map: loader.load('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg'),
                bumpMap: loader.load('https://unpkg.com/three-globe/example/img/earth-topology.png'),
                bumpScale: 0.15,
                specularMap: loader.load('https://unpkg.com/three-globe/example/img/earth-water.png'),
                specular: new THREE.Color('grey')
            });
            const earth = new THREE.Mesh(earthGeo, earthMat);
            group.add(earth);

            // 云层
            const cloudGeo = new THREE.SphereGeometry(5.05, 64, 64);
            const cloudMat = new THREE.MeshPhongMaterial({
                map: loader.load('https://unpkg.com/three-globe/example/img/earth-clouds.png'),
                transparent: true,
                opacity: 0.8,
                blending: THREE.AdditiveBlending,
                side: THREE.DoubleSide
            });
            const clouds = new THREE.Mesh(cloudGeo, cloudMat);
            group.add(clouds);

            // 大气层发光 (Sprite Glow)
            const spriteMaterial = new THREE.SpriteMaterial({
                map: new THREE.CanvasTexture(generateGlowTexture()),
                color: 0x4CA1FF,
                transparent: true,
                opacity: 0.6,
                blending: THREE.AdditiveBlending
            });
            const sprite = new THREE.Sprite(spriteMaterial);
            sprite.scale.set(12, 12, 1.0);
            group.add(sprite);

            // 灯光
            const sunLight = new THREE.DirectionalLight(0xffffff, 1.2);
            sunLight.position.set(10, 5, 10);
            scene.add(sunLight);
            scene.add(new THREE.AmbientLight(0x111111)); // 微弱环境光

            // 动画循环
            function animate() {
                requestAnimationFrame(animate);
                // 如果没在拖拽，就自动旋转
                if (!isDragging) {
                    group.rotation.y += 0.001;
                    clouds.rotation.y += 0.0012; 
                }
                renderer.render(scene, camera);
            }
            animate();

            // --- 拖拽逻辑 ---
            // PC端
            pl.addEventListener('mousedown', (e) => { isDragging = true; previousMousePosition = { x: e.clientX, y: e.clientY }; });
            document.addEventListener('mouseup', () => { isDragging = false; });
            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const deltaMove = { x: e.clientX - previousMousePosition.x, y: e.clientY - previousMousePosition.y };
                    group.rotation.y += deltaMove.x * 0.005;
                    group.rotation.x += deltaMove.y * 0.005;
                    previousMousePosition = { x: e.clientX, y: e.clientY };
                }
            });
            // 移动端
            pl.addEventListener('touchstart', (e) => { isDragging = true; previousMousePosition = { x: e.touches[0].clientX, y: e.touches[0].clientY }; });
            document.addEventListener('touchend', () => { isDragging = false; });
            document.addEventListener('touchmove', (e) => {
                if (isDragging) {
                    const deltaMove = { x: e.touches[0].clientX - previousMousePosition.x, y: e.touches[0].clientY - previousMousePosition.y };
                    group.rotation.y += deltaMove.x * 0.005;
                    group.rotation.x += deltaMove.y * 0.005;
                    previousMousePosition = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                }
            });

            // 双击进入
            pl.addEventListener('dblclick', () => {
                document.getElementById('intro-screen').style.opacity = 0;
                setTimeout(() => {
                    document.getElementById('intro-screen').style.display = 'none';
                    document.getElementById('main-app').classList.add('active');
                    loadMemories();
                }, 1000);
            });
            
            // 窗口大小改变
            window.addEventListener('resize', () => {
                const width = window.innerWidth;
                const height = window.innerHeight;
                renderer.setSize(width, height);
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
            });
        }

        // 生成光晕纹理
        function generateGlowTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 64; canvas.height = 64;
            const context = canvas.getContext('2d');
            const gradient = context.createRadialGradient(32, 32, 0, 32, 32, 32);
            gradient.addColorStop(0, 'rgba(255, 255, 255, 1)');
            gradient.addColorStop(0.5, 'rgba(255, 255, 255, 0.2)');
            gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
            context.fillStyle = gradient;
            context.fillRect(0, 0, 64, 64);
            return canvas;
        }


        // 通用逻辑
        const player = document.getElementById('bgm-player');
        let currentPlayingCard = null;
        function toggleMusic(url, cardEl) {
            if (!url) return;
            if (currentPlayingCard === cardEl) { if (player.paused) { player.play(); cardEl.classList.add('playing'); } else { player.pause(); cardEl.classList.remove('playing'); } return; }
            if (currentPlayingCard) { currentPlayingCard.classList.remove('playing'); player.pause(); }
            player.src = url; player.volume = 0.6;
            player.play().then(() => { cardEl.classList.add('playing'); currentPlayingCard = cardEl; }).catch(e => console.log(e));
        }
        async function deleteMemory(id, e) { e.stopPropagation(); if(!confirm("删除?")) return; const o = AV.Object.createWithoutData('Memory', id); await o.destroy(); document.getElementById('card-' + id).remove(); }
        function setupDrag(el) { let isD=false,sX,sY,iL,iT; el.addEventListener('mousedown',(e)=>{if(e.target.closest('.btn-delete'))return; isD=true; sX=e.clientX; sY=e.clientY; iL=el.offsetLeft; iT=el.offsetTop; el.style.cursor='grabbing';}); window.addEventListener('mousemove',(e)=>{if(!isD)return; el.style.left=`${iL+(e.clientX-sX)}px`; el.style.top=`${iT+(e.clientY-sY)}px`;}); window.addEventListener('mouseup',()=>{isD=false;el.style.cursor='grab';}); }
        function scatterCards() { const cs=document.querySelectorAll('.memory-card'); const W=document.getElementById('right-panel').offsetWidth; const H=document.getElementById('right-panel').offsetHeight; cs.forEach(c=>{c.style.left=Math.max(0,Math.random()*(W-300))+'px'; c.style.top=Math.max(0,Math.random()*(H-200))+'px'; c.style.transform=`rotate(${(Math.random()-0.5)*20}deg)`;}); }
        
        // 流星 (超级减速版)
        const cvs = document.getElementById('meteor-canvas'); const ctx = cvs.getContext('2d'); 
        let mets = []; 
        function resizeCanvas(){cvs.width=document.getElementById('right-panel').offsetWidth;cvs.height=document.getElementById('right-panel').offsetHeight;} 
        window.addEventListener('resize',resizeCanvas);
        class Met{
            constructor(){this.reset();}
            reset(){
                this.x=Math.random()*cvs.width*0.8; // 范围稍微集中
                this.y=Math.random()*cvs.height*0.8 - 200; 
                this.len=Math.random()*150+50; // 变长
                this.speed=Math.random()*0.2 + 0.1; // 极慢速度!
                this.angle=Math.PI/3; // 60度下落
                this.opacity = Math.random() * 0.5 + 0.1; // 透明度
            }
            update(){
                this.x+=this.speed*Math.cos(this.angle);
                this.y+=this.speed*Math.sin(this.angle);
                if(this.x>cvs.width+100||this.y>cvs.height+100)this.reset();
            }
            draw(){
                ctx.save();
                ctx.translate(this.x,this.y);
                ctx.rotate(this.angle);
                const g=ctx.createLinearGradient(0,0,-this.len,0);
                g.addColorStop(0,`rgba(255,255,255,${this.opacity})`); // 头部
                g.addColorStop(1,"rgba(255,255,255,0)"); // 尾部透明
                ctx.fillStyle=g;
                ctx.beginPath();
                ctx.moveTo(0,0);
                ctx.lineTo(-this.len,-1); // 变细
                ctx.lineTo(-this.len,1);
                ctx.fill();
                ctx.restore();
            }
        }
        for(let i=0;i<15;i++)mets.push(new Met()); // 数量减少，保持稀缺美
        function loop(){ctx.clearRect(0,0,cvs.width,cvs.height);mets.forEach(m=>{m.update();m.draw();});requestAnimationFrame(loop);}
        loop();
    </script>
</body>
</html>